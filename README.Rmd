---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The name of this R package, `reem`, stands for:
**R**enewal **E**quation based **E**pidemic **M**odel

This package simulates and fits infectious disease epidemic to 
clinical and wastewater data.

To install: `devtools::install_github("phac-nml-phrsd/reem")`


## Model description

The epidemic model is a traditional SIR model but implemented as a
renewal equation instead of the more populate ordinary differential
equations (ODE).
It has been shown that the renewal equation implementation is 
\emph{mathematically} equivalent to the ODE one. 
See for example: D. Fargue, Reducibilite des systemes hereditaires, Int. J. Nonlinear Mech., 9 (1974), pp. 331--338, D. Breda et al On  the  formulation  of  epidemic  models  (an  appraisal  of  Kermack  and  McKendrick), J. Biol. Dyn.,6 (2012), pp. 103--117, and Champredon et al. Equivalence of the Erlang-Distributed SEIR Epidemic Model and the Renewal Equation, SIAM J. Appl. Math., 78 (2018).

The renewal equation of the pathogen transmission process is as follows:

$$i(t) = e^{-\alpha}\, \mathcal{R}_0 \, B(t) \sum_{k=1}^\ell g(k)i(t-k)$$

where $i(t)$ is the incidence at time $t$,  
$\mathcal{R}_0$ is the basic reproduction number, 
TO FINISH...



## Simulation example

The code below simulates an epidemic, tracking the spread in the population
and the pathogen concentration in the wastewater.

```{r define_model, warning=FALSE, echo=TRUE}
library(reem)
library(lubridate)
library(patchwork)

# Define model parameters

prms = list(
  horizon  = 90,  # horizon of the simulation
  last.obs = 88,  # last observation time (must be < horizon)
  B        = rep(1,90), # time dependent multiplicative factor for transmission
  i0prop  = 1e-3,  # initial proportion of the population infected
  date.start = lubridate::ymd('2022-01-01'), # start date of the epidemic
  start.delta = 0, 
  R0      = 1.5, # Basic reproduction number
  N       = 1e4, # population size
  alpha   = -10, # transmission heterogeneity (alpha=-Inf: homogeneous)
  I.init  = c(1,1,3,5), # initial incidence (overwritten in fit ABC)
  lag     = 7,   # Aggregation window for clinical reports
  rho     = 0.1, # mean reporting ratio
  g       = get_gi(), # Generation interval distribution
  fec     = get_fecalshed(), # fecal shedding kinetics
  kappa   = 0.18, # pathogen decay in ww
  psi     = get_psi(), # plug flow simulation,
  shed.mult = 0.2 # deposited fecal shedding multiplier  
)

# Create the model object instance
obj = new('reem', 
          name = 'foo', 
          prms = prms, 
          is.fitted = FALSE)

# Print (formatted) the model parameters
obj$print_prms()

# Simulate an epidemic based on the parameters
simepi  = obj$simulate_epi(deterministic = FALSE)

```

We can use the built-in function `plot_epi()` to plot the epidemic

```{r plot_epi, fig.width=12, warning=FALSE}
g = plot_epi(simepi)
plot(patchwork::wrap_plots(g, ncol = 1))
```


`devtools::build_readme()`


## Fit example

If we attach observation data (from clinical and/or wastewater surveillance),
to a `reem` object, then it is possible to fit its model parameters to these data. The example below shows how to do this.


First, let's create synthetic observation data from the simulation example above. We use synthetic data (as opposed to real data) because we to assess the accuracy of the fit. The synthetic data are generated from the vey same model `reem` where we know all the parameters. 

```{r}
# we use the example above and make a copy of its
# simulated epidemics. The time series will be the "observations".

#FIXME
# thecopy below may not update the new object `sim.data`
# ==> redefine `sim.data` from scratch
sim.data = simepi

# Set the date for "today"
asof = ymd('2023-03-01') 

# Retrieve the simulated observations
obs.cl = filter(sim.data$obs.cl, date <= asof)
obs.ww = filter(simepi$obs.ww, date <= asof)

# shift the dates such that they 
# do not perfectly align with the simulation
obs.cl$t <- obs.cl$t + 1
obs.cl$date <- obs.cl$date + 1

# Attached simulated data to new `reem` object:

prms = prms0
prms$t.obs.cl <- NULL
prms$t.obs.ww <- NULL
obj  = new('reem', 
           name = 'foo2', 
           prms = prms, 
           obs.cl = obs.cl,
           obs.ww = obs.ww,
           is.fitted = FALSE)

# Define the parameters for the ABC fitting algorithm
prm.abc = list(
  n.abc = 500,
  n.sim = 0,     #`0` for deterministic, else`8` should be enough
  p.abc = 0.02, #1e-2,
  n.cores = 1, #min(12, parallel::detectCores() - 1),
  use.cl = 1, 
  use.ww = 1,
  err.type = 'L2'
)

# Definethe priors of the parameters to be fitted:
  prms.to.fit = list(
    R0          = list('gamma', 2.5, 0.251),
    alpha       = list('normp', 2, 1),
    i0prop      = list('unif', -5, -2),
    start.delta = list('unif_int', -7, 7)  
  )

  #  Launch the actual fit 
   thefit = obj$fit_abc(prm.abc, prms.to.fit)  
  
  gg = obj$plot_fit()
 
  plot(gg$all) 
  
  
```


